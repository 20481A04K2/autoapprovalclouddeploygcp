# ==============================
# Delivery Pipeline
# ==============================
apiVersion: deploy.cloud.google.com/v1
kind: DeliveryPipeline
metadata:
  name: cloudrun-app-pipeline1
description: Cloud Run pipeline with repair/failover automation
serialPipeline:
  stages:
    - targetId: dev
      profiles: [dev]
    - targetId: qa
      profiles: [qa]
    - targetId: prod
      profiles: [prod]

# ==============================
# Automation for repair/failover (prod)
# ==============================
---
apiVersion: deploy.cloud.google.com/v1
kind: Automation
metadata:
  name: cloudrun-app-pipeline1/repair-rollout
description: Automatically retries failed rollouts and rolls back if retries fail
suspended: false
serviceAccount: 764196271662-compute@developer.gserviceaccount.com
selector:
  targets:
    - id: prod
rules:
  - repairRolloutRule:
      name: repair-rollout
      repairPhases:
        - retry:
            attempts: 2
            wait: 1m
            backoffMode: LINEAR
        - rollback:
            destinationPhase: "stable"

# ==============================
# Auto Promotion from dev → qa
# ==============================
---
apiVersion: deploy.cloud.google.com/v1
kind: Automation
metadata:
  name: cloudrun-app-pipeline1/promote-dev-to-qa
description: Auto promote from dev → qa after 1m wait
suspended: false
serviceAccount: 764196271662-compute@developer.gserviceaccount.com
selector:
  targets:
    - id: dev
rules:
  - promoteReleaseRule:
      name: auto-promote-to-qa
      wait: 1m
      toTargetId: qa

# ==============================
# Auto Promotion from qa → prod
# ==============================
---
apiVersion: deploy.cloud.google.com/v1
kind: Automation
metadata:
  name: cloudrun-app-pipeline1/promote-qa-to-prod
description: Auto promote from qa → prod after 1m wait
suspended: false
serviceAccount: 764196271662-compute@developer.gserviceaccount.com
selector:
  targets:
    - id: qa
rules:
  - promoteReleaseRule:
      name: auto-promote-to-prod
      wait: 1m
      toTargetId: prod

# ==============================
# Targets
# ==============================
---
apiVersion: deploy.cloud.google.com/v1
kind: Target
metadata:
  name: dev
description: Cloud Run dev environment
run:
  location: projects/divine-course-470809-f6/locations/asia-south1
---
apiVersion: deploy.cloud.google.com/v1
kind: Target
metadata:
  name: qa
description: Cloud Run qa environment
run:
  location: projects/divine-course-470809-f6/locations/asia-south1
---
apiVersion: deploy.cloud.google.com/v1
kind: Target
metadata:
  name: prod
description: Cloud Run prod environment
run:
  location: projects/divine-course-470809-f6/locations/asia-south1
